"use strict";exports.id=128,exports.ids=[128],exports.modules={830:(o,e,a)=>{a.d(e,{Framework:()=>d});var r=a(760),i=a.n(r),s=a(161),n=a.n(s),t=a(124),l=a(765),c=a(386),g=a(763),J=a(582);class d{static async add(o,e){if(console.log(t.J.colorize([t.J.FgCyan,t.J.Bright],"Añadiendo frameworks")),console.group(),"win32"==n().platform())return console.log(t.J.colorize([t.J.FgRed],"No disponible en Windows")),console.groupEnd(),!1;await(0,c.Ck)(`${o}/tmp`,!0);const a=[];for(const r of e)a.push(this.download(r,`${o}/framework/${r}`));const r=await Promise.all(a).catch((o=>(console.groupEnd(),Promise.reject(o))));return console.groupEnd(),!!r.reduce(((o,e)=>o||e),!1)&&(await J.R.install(o,{verbose:!1}),!0)}static async remove(o,e){if(console.log(t.J.colorize([t.J.FgCyan,t.J.Bright],"Eliminando frameworks")),console.group(),"win32"==n().platform())return console.log(t.J.colorize([t.J.FgRed],"No disponible en Windows")),console.groupEnd(),!1;await(0,c.Ck)(`${o}/tmp`,!0);const a=[];for(const r of e.filter((o=>"services-comun"!=o)))await(0,c.Q7)(`${o}/framework/${r}`)&&(console.log(t.J.colorize([t.J.FgMagenta],r),"=> Eliminando"),a.push((0,c.y1)(`${o}/framework/${r}`).then((()=>(console.log(t.J.colorize([t.J.FgMagenta],r),`=> Eliminando [${t.J.colorize([t.J.FgGreen,t.J.Bright],"OK   ")}]`),!0))).catch((o=>(console.log(t.J.colorize([t.J.FgMagenta],r),`=> Eliminando [${t.J.colorize([t.J.FgRed,t.J.Bright],"ERROR")}]`),Promise.reject(o))))));const r=await Promise.all(a).catch((o=>(console.groupEnd(),Promise.reject(o))));return console.groupEnd(),!!r.reduce(((o,e)=>o||e),!1)&&(await J.R.install(o,{verbose:!1}),!0)}static async update(o){if(console.log(t.J.colorize([t.J.FgCyan,t.J.Bright],"Comprobando frameworks")),console.group(),"win32"==n().platform())return console.log(t.J.colorize([t.J.FgRed],"No disponible en Windows")),console.groupEnd(),!1;await(0,c.Ck)(`${o}/tmp`,!0);const e=[];for(const a of await(0,c.Ci)(`${o}/framework`))e.push(this.download(a,`${o}/framework/${a}`));const a=await Promise.all(e).catch((o=>(console.groupEnd(),Promise.reject(o))));return console.groupEnd(),a.reduce(((o,e)=>o||e),!1)}static async push(o){if(console.log(t.J.colorize([t.J.FgCyan,t.J.Bright],"Enviando frameworks")),console.group(),"win32"==n().platform())return console.log(t.J.colorize([t.J.FgRed],"No disponible en Windows")),console.groupEnd(),!1;const e=`${o}/tmp`;await(0,c.Ck)(e,!0);for(const o of await(0,c.Ci)(e))await(0,c.y1)(`${e}/${o}`);const a=[];for(const r of await(0,c.Ci)(`${o}/framework`))a.push(this.upload(r,`${o}/framework/${r}`,`${e}/${r}`));const r=await Promise.all(a).catch((o=>(console.groupEnd(),Promise.reject(o))));return console.groupEnd(),r.reduce(((o,e)=>o||e),!1)}static dateVersion(o){const[e,a]=o.split("+"),r=new Date(e);return r.setUTCMinutes(parseInt(a)),r.getTime()}static async parseDir(o){const e=[];if(await(0,c.Q7)(o)){for(const a of await(0,c.Ci)(o)){const r=o+"/"+a;await(0,c.Q7)(r)?e.push(await this.parseDir(r)):await(0,c.fo)(r)&&e.push((0,g.F)(await(0,c.Cj)(r)))}return e.join("")}return await(0,c.fo)(o)?(0,g.F)(await(0,c.Cj)(o)):""}static async upload(o,e,a){const r=await(0,c.TQ)(`${e}/package.json`),i=r.version??"2022.1.1+0",s=this.dateVersion(i),n=r.hash??"",{status:J,stdout:d}=await l.O.spawn("gsutil",["cat",`gs://meteored-yarn-workspaces/${o}/package.json`]);if(0==J){const e=JSON.parse(d);if(this.dateVersion(e.version??"0000.00.00+0")>s)return console.log(t.J.colorize([t.J.FgMagenta],o),`=> Existe una nueva versión para descargar ${t.J.colorize([t.J.FgBlue],i)} => ${t.J.colorize([t.J.FgGreen],e.version)} [${t.J.colorize([t.J.FgRed,t.J.Bright],"ERROR")}]`),!1}delete r.version,delete r.hash,await(0,c.TC)(`${e}/package.json`,`${JSON.stringify(r,null,2)}\n`,!0),await(0,c.Ck)(a,!0),await(0,c.Q7)(`${e}/files`)&&await(0,c.$w)(`${e}/files`,`${a}/files`);const u=(0,g.F)(await this.parseDir(`${e}/`));if(u!==n){const a=/^(\d{4}\.\d{1,2}\.\d{1,2})\+(\d+)$/.exec(i);let s,n;null==a?(s="2022.1.1",n="1"):(s=a[1],n=a[2]);const c=new Date,g=[c.getUTCFullYear(),c.getUTCMonth()+1,c.getUTCDate()].join(".");let J;J=s===g?parseInt(n)+1:1,await this.updatePackage(e,r,`${g}+${J}`,u),console.log(t.J.colorize([t.J.FgMagenta],o),`=> Subiendo nueva versión ${t.J.colorize([t.J.FgBlue],i)} => ${t.J.colorize([t.J.FgGreen],r.version)}`),await l.O.spawn("gsutil",["-o",'"GSUtil:parallel_process_count=1"',"-m","rm","-r",`gs://meteored-yarn-workspaces/${o}`]),await l.O.spawn("gsutil",["-o",'"GSUtil:parallel_process_count=1"',"-m","cp","-r",e,"gs://meteored-yarn-workspaces/"]),console.log(t.J.colorize([t.J.FgMagenta],o),`=> Subiendo nueva versión ${t.J.colorize([t.J.FgBlue],i)} => ${t.J.colorize([t.J.FgGreen],r.version)} [${t.J.colorize([t.J.FgGreen,t.J.Bright],"OK   ")}]`)}else await this.updatePackage(e,r,i,n),J>0?(console.log(t.J.colorize([t.J.FgMagenta],o),`=> Subiendo versión ${t.J.colorize([t.J.FgBlue],i)}`),await l.O.spawn("gsutil",["-o",'"GSUtil:parallel_process_count=1"',"-m","cp","-r",e,"gs://meteored-yarn-workspaces/"]),console.log(t.J.colorize([t.J.FgMagenta],o),`=> Subiendo versión ${t.J.colorize([t.J.FgBlue],i)} [${t.J.colorize([t.J.FgGreen,t.J.Bright],"OK   ")}]`)):console.log(t.J.colorize([t.J.FgMagenta],o),`=> ${t.J.colorize([t.J.FgBlue],"Nada que subir")}`);return await(0,c.Q7)(`${a}/files`)&&await(0,c.$w)(`${a}/files`,`${e}/files`),await(0,c.Nr)(a),!0}static async updatePackage(o,e,a,r){e.version=a,e.hash=r,await(0,c.TC)(`${o}/package.json`,`${JSON.stringify(e,null,2)}\n`,!0)}static async download(o,e){const a=await(0,c.fo)(`${e}/package.json`),r=a?await(0,c.TQ)(`${e}/package.json`):{version:"0000.0.0+0"},s=r.version??"0000.0.0+0",n=this.dateVersion(s);let g=r;{const{status:e,stdout:r,stderr:i}=await l.O.spawn("gsutil",["cat",`gs://meteored-yarn-workspaces/${o}/package.json`]);if(0!=e)return i.includes("No URLs matched")?(console.log(t.J.colorize([t.J.FgMagenta],o),`=> [${t.J.colorize([t.J.FgYellow,t.J.Bright],"NUEVO")}]`),!0):(console.log(t.J.colorize([t.J.FgMagenta],o),`=> [${t.J.colorize([t.J.FgRed,t.J.Bright],"ERROR")}]`),console.log(t.J.colorize([t.J.FgMagenta],o),"=>",i),Promise.reject());if(g=JSON.parse(r),n>=this.dateVersion(g.version))return console.log(t.J.colorize([t.J.FgMagenta],o),`=> Actualizado ${t.J.colorize([t.J.FgBlue],s)}`),!1;a?console.log(t.J.colorize([t.J.FgMagenta],o),`=> Nueva versión ${t.J.colorize([t.J.FgBlue],s)} => ${t.J.colorize([t.J.FgGreen],g.version)}`):console.log(t.J.colorize([t.J.FgMagenta],o),`=> Instalando ${t.J.colorize([t.J.FgGreen],g.version)}`)}if(a){const{status:a,stdout:r,stderr:i}=await l.O.spawn("git",["diff","--name-only",e]);if(0!=a)return console.log(t.J.colorize([t.J.FgMagenta],o),`=> ${t.J.colorize([t.J.FgRed],"Error comprobando cambios locales")}`),console.log(t.J.colorize([t.J.FgMagenta],o),`=> ${i}`),Promise.reject();const n=r.trim();if(n.length>0)return await this.downloadError(o,s,g.version,n.split("\n"))}const J=i().resolve(e,"../../tmp");await Promise.all([this.clearTMP(`${J}/${o}`),this.clearTMP(`${J}/${o}-old`)]);const{status:d,stderr:u}=await l.O.spawn("gsutil",["-o",'"GSUtil:parallel_process_count=1"',"-m","cp","-r",`gs://meteored-yarn-workspaces/${o}`,J]);return 0!=d?await this.downloadError(o,s,g.version,u.split("\n")):a&&(await(0,c.Q7)(`${e}/files`)&&await(0,c.$w)(`${e}/files`,`${J}/${o}/files`),!await(0,c.$w)(e,`${J}/${o}-old`))?await this.downloadError(o,s,g.version,[`No se puede renombrar de ${e} a ${J}/${o}-old`]):await(0,c.$w)(`${J}/${o}`,e)?(a?console.log(t.J.colorize([t.J.FgMagenta],o),`=> Nueva versión ${t.J.colorize([t.J.FgBlue],s)} => ${t.J.colorize([t.J.FgGreen],g.version)} [${t.J.colorize([t.J.FgGreen,t.J.Bright],"OK   ")}]`):console.log(t.J.colorize([t.J.FgMagenta],o),`=> Instalando ${t.J.colorize([t.J.FgGreen],g.version)} [${t.J.colorize([t.J.FgGreen,t.J.Bright],"OK   ")}]`),!0):await this.downloadError(o,s,g.version,[`No se puede renombrar de ${J}/${o} a ${e}`])}static async downloadError(o,e,a,r=[]){console.log(t.J.colorize([t.J.FgMagenta],o),`=> Nueva versión ${t.J.colorize([t.J.FgBlue],e)} => ${t.J.colorize([t.J.FgGreen],a)} [${t.J.colorize([t.J.FgRed,t.J.Bright],"ERROR")}]`),console.group();for(const o of r)console.log(t.J.colorize([t.J.FgYellow],o));return console.groupEnd(),Promise.reject()}static async clearTMP(o){(await(0,c.Q7)(o)||await(0,c.fo)(o))&&await(0,c.y1)(o)}}}};
//# sourceMappingURL=framework.js.map